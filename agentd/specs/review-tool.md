# Specification: Review MCP Tool

## Overview

Add a `create_review` MCP tool that allows the implementation agent (Codex) to submit structured code review findings. This ensures that `REVIEW.md` is populated with a consistent, machine-readable, and human-friendly summary of the implementation results.

## Requirements

### RT-R1: Structured Review Submission
The tool MUST accept a structured payload containing the verdict, a summary of changes, test results, and a list of specific issues found during verification.

### RT-R2: Standardized Verdicts
Verdicts MUST be limited to a predefined set: `APPROVED`, `NEEDS_FIX`, or `MAJOR_ISSUES`.

### RT-R3: Markdown Generation
The service logic MUST format the structured input into a standardized `REVIEW.md` file located in the change directory. The format must be compatible with the Agentd implementation workflow's review parser.

### RT-R4: Category and Severity for Issues
Each reported issue MUST include a title, severity (High, Medium, Low), category (Bug, Security, Performance, Style), and optional file/line references.

## Data Model

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["change_id", "verdict", "summary"],
  "properties": {
    "change_id": { "type": "string" },
    "verdict": { "type": "string", "enum": ["APPROVED", "NEEDS_FIX", "MAJOR_ISSUES"] },
    "summary": { "type": "string" },
    "test_results": {
      "type": "object",
      "properties": {
        "passed": { "type": "integer" },
        "failed": { "type": "integer" },
        "total": { "type": "integer" }
      }
    },
    "issues": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["title", "severity", "category", "description"],
        "properties": {
          "title": { "type": "string" },
          "severity": { "type": "string", "enum": ["High", "Medium", "Low"] },
          "category": { "type": "string" },
          "file": { "type": "string" },
          "line": { "type": "integer" },
          "description": { "type": "string" },
          "recommendation": { "type": "string" }
        }
      }
    }
  }
}
```

## Interfaces

```
FUNCTION create_review(payload: ReviewPayload) -> Result<String>
  INPUT: Structured review data (verdict, summary, issues)
  OUTPUT: Success message or Error
  SIDE_EFFECTS: Creates or updates agentd/changes/{change_id}/REVIEW.md

FUNCTION format_review_markdown(payload: ReviewPayload) -> String
  INPUT: Structured review data
  OUTPUT: Markdown string formatted for REVIEW.md
```

## Acceptance Criteria

### Scenario: Successful Review Creation
- **WHEN** Codex calls `create_review` with a `NEEDS_FIX` verdict and 2 issues
- **THEN** `REVIEW.md` is created with a clear "Verdict: NEEDS_FIX" header
- **THEN** the issues are listed with their respective severities and descriptions.

### Scenario: Automated Workflow Resumption
- **WHEN** `REVIEW.md` is generated by the tool with verdict `APPROVED`
- **THEN** the Agentd `impl` workflow correctly identifies the approved state and transitions the phase to `complete`.

### Scenario: Validation of Verdicts
- **WHEN** the tool is called with an invalid verdict string
- **THEN** it returns a validation error and does not modify `REVIEW.md`.