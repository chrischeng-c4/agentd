---
id: mcp-tool-enforcement
type: spec
title: "MCP Tool Enforcement"
version: 1
created_at: 2026-01-19T14:00:00Z
updated_at: 2026-01-19T14:50:00Z
requirements:
  total: 6
  ids:
    - R1
    - R2
    - R3
    - R4
    - R5
    - R6
design_elements:
  has_mermaid: false
  has_json_schema: true
  has_pseudo_code: false
  has_api_spec: false
---

<spec>

# Specification: MCP Tool Enforcement

## Overview

This specification defines the requirements for enforcing the use of MCP tools for all file generation and modification within the Agentd orchestrator. By ensuring agents use structured tools instead of direct file system access, we maintain consistency, validation, and traceability across all agents (Gemini, Codex, etc.).

## Requirements

### R1: Prompt-Level Enforcement
- Prompt templates must explicitly forbid direct file writing (e.g., using `write_file` or raw markdown output).
- Prompts must provide JSON schemas and examples for the expected MCP tool calls.
- Instructions must clearly state that *all* file generation and modifications (proposals, specs, tasks, reviews) must go through their respective MCP tools.
- This applies to all agents, including Gemini (for planning) and Codex (for challenging).
- **Advisory Enforcement**: Bypass detection is prompt-based and advisory in this iteration. No runtime write guards are required.

### R2: Orchestrator Compliance
- Orchestrators (Gemini, Codex, Claude) must use prompts that direct the agent to call MCP tools.
- The `proposal_engine.rs` should favor sequential workflows where each phase uses one-shot runs with fresh contexts, ensuring tools are used to "finalize" each artifact.
- Fallbacks to `write_file` or direct editing in templates must be removed to prevent agents from bypassing the structured tools.
- **Metadata Preservation**: MCP tools should be update-aware, preserving existing metadata (like `created_at` or `author`) when overwriting files.

### R3: Tool Coverage (New Tools)
- All core Agentd artifacts must have corresponding MCP tools.
- **append_review**: A new MCP tool must be exposed to allow agents to add review blocks to `proposal.md` in a structured format.
  - Input: `change_id`, `status` (approved/needs_revision/rejected/resolved), `iteration`, `reviewer`, `content`.
  - Output: Updates `proposal.md` using the existing `append_review` logic (XML wrapping).
- **Artifact Consolidation**: Expose a tool or logic to deprecate and remove `CHALLENGE.md` generation.

### R4: Consistency and Validation
- MCP tools must implement validation logic (e.g., min length for overview, valid YAML blocks, correct file paths).
- Files generated by MCP tools must be guaranteed to follow the project's standard structure (YAML frontmatter + XML wrapping).

### R5: Template and Skeleton Updates
- Guidance templates (`GEMINI.md`, `AGENTS.md`, `proposal.toml`) must be updated to prioritize MCP tool usage and deprecate direct writing.
- **Remove all references to `CHALLENGE.md`** from templates and instructions.
- Planning skeletons should include warnings against manual file creation to guide agents towards tool usage.
- **Delete `challenge.md` skeleton.**

### R6: Workflow & CLI Refactor
- Update `proposal_engine.rs`, `validate_challenge.rs`, and `parser/challenge.rs` to stop using `CHALLENGE.md` and exclusively use `<review>` blocks in `proposal.md`.
- Ensure `agentd challenge` command calls the agent with the new `append_review` tool instructions.

## Data Model (append_review)

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["change_id", "status", "iteration", "reviewer", "content"],
  "properties": {
    "change_id": { "type": "string" },
    "status": { "type": "string", "enum": ["approved", "needs_revision", "rejected", "resolved"] },
    "iteration": { "type": "integer", "minimum": 1 },
    "reviewer": { "type": "string" },
    "content": { "type": "string", "description": "Markdown content of the review" }
  }
}
```

## Acceptance Criteria

### WHEN Gemini is asked to generate a proposal THEN it must use the create_proposal tool
- **GIVEN** a new change request
- **WHEN** Gemini generates the proposal
- **THEN** it calls the `create_proposal` MCP tool with the required JSON payload.

### WHEN Gemini is asked to generate a technical specification THEN it must use the create_spec tool
- **GIVEN** a proposal that lists affected specs
- **WHEN** Gemini generates a spec
- **THEN** it calls the `create_spec` MCP tool and the file is created in the correct `specs/` directory.

### WHEN Codex is asked to challenge a proposal THEN it must use the append_review tool
- **GIVEN** a proposal ready for challenge
- **WHEN** Codex performs the challenge
- **THEN** it calls the `append_review` MCP tool to add its findings to `proposal.md`.

### WHEN an agent attempts to bypass MCP tools THEN the self-review phase must identify this as a violation
- **GIVEN** an agent that outputs raw markdown instead of a tool call
- **WHEN** the self-review phase runs
- **THEN** it returns `NEEDS_REVISION` and instructs the agent to use the correct MCP tool.

</spec>
