# Implementation Notes: agent-agnostic-prompts-2

## Status: In Progress

This change is still in the planning/infrastructure phase. The following bug fixes were made to unblock the workflow:

## Bug Fixes (Iteration 1)

### 1. State Update Bug (src/cli/proposal_engine.rs)
**Issue**: After the planning workflow completed (proposal → challenge → reproposal loop), the STATE.yaml phase was not updated to `challenged`, causing `agentd implement` to reject the change.

**Fix**: Added state update logic at the end of `run_proposal_loop()` to:
- Set phase to `Challenged` when verdict is APPROVED
- Set phase to `Challenged` when verdict is NEEDS_REVISION but max iterations reached or only minor issues remain
- Set phase to `Rejected` when verdict is REJECTED

### 2. Tasks.md Parsing Bug (src/models/task_graph.rs)
**Issue**: The `TaskGraph::parse_tasks()` function only supported YAML block format (`yaml...`), but Gemini generates markdown checkbox format.

**Fix**: Added `parse_markdown_tasks()` function to support both formats:
- YAML blocks (generated by MCP `create_tasks` tool)
- Markdown checkbox format (generated by Gemini during self-review)

## Remaining Work

The core agent-agnostic prompt system has not been implemented yet. The following tasks from `tasks.md` are still pending:

### Data Layer
- [ ] 1.1 Create `UnifiedPrompt` data model (`src/models/prompt.rs`)
- [ ] 1.2 Register `prompt` module

### Logic Layer
- [ ] 2.1 Implement template loading and variable interpolation
- [ ] 2.2 Implement centralized marker parsing utilities
- [ ] 2.3 Centralize prompt assembly logic

### Integration Layer
- [ ] 3.1 Create system prompt templates (`templates/system/`)
- [ ] 3.2-3.4 Update Gemini/Claude/Codex orchestrators
- [ ] 3.5 Refactor orchestrator orchestration logic

### Testing Layer
- [ ] 4.1-4.3 Unit and integration tests

## Test Status
- All 418 tests pass (including doctests)
- No security vulnerabilities identified
